# Database Migration System Guide

## Overview

The CCFlare database system has been migrated from a legacy SQLite-only system to a modern Drizzle ORM-based system that supports multiple database providers (SQLite, PostgreSQL, MySQL).

## Migration Systems

### üÜï New System (Recommended)
- **Location**: `src/migrations/drizzle-migrations.ts`
- **Used by**: `DrizzleDatabaseOperations` (current default)
- **Features**:
  - Multi-provider support (SQLite, PostgreSQL, MySQL)
  - **Proper Drizzle migration files** generated by `drizzle-kit`
  - Type-safe schema definitions
  - Automatic compatibility with legacy databases
  - Fallback to schema creation if migration files missing

### üö® Legacy System (Deprecated)
- **Location**: `src/migrations.ts`
- **Used by**: `DatabaseOperations` (legacy)
- **Status**: Deprecated, kept for backward compatibility
- **Features**: SQLite-only, manual SQL migrations

## Current Architecture

```
Factory.ts
    ‚Üì
DrizzleDatabaseOperations (default)
    ‚Üì
drizzle-migrations.ts
    ‚Üì
MigrationCompatibility (for legacy databases)
```

## Migration Compatibility

The new system automatically detects and handles legacy databases:

1. **Fresh Installation**: Creates schema using Drizzle definitions
2. **Legacy Database**: Applies compatibility migrations to ensure all columns exist
3. **Mixed Environment**: Seamlessly handles both scenarios

### Compatibility Features

- ‚úÖ Automatic detection of legacy schema
- ‚úÖ Non-destructive migrations (additive only)
- ‚úÖ Missing column detection and addition
- ‚úÖ Missing table creation
- ‚úÖ Index creation and optimization
- ‚úÖ Preserves all existing data

## Schema Definitions

All schema definitions are now centralized in `src/schema/`:

- `accounts.ts` - User account management
- `requests.ts` - API request logging
- `request-payloads.ts` - Request/response data storage
- `oauth-sessions.ts` - OAuth session management
- `agent-preferences.ts` - Agent configuration
- `strategies.ts` - Load balancing strategies

## Database Provider Support

### SQLite (Default)
- File-based database
- Automatic WAL mode optimization
- Integer timestamps
- Boolean as INTEGER (0/1)

### PostgreSQL
- UUID primary keys
- TIMESTAMPTZ for timestamps
- Native BOOLEAN type
- JSONB for JSON data

### MySQL
- VARCHAR(36) for UUIDs
- TIMESTAMP for timestamps
- Native BOOLEAN type
- Native JSON type

## Migration Process

### For New Projects
```typescript
// Automatically uses new Drizzle system
const db = DatabaseFactory.getInstance();
```

### For Existing Projects
The system automatically detects legacy databases and applies compatibility migrations:

1. Checks for existing schema
2. Applies missing column migrations
3. Creates missing tables
4. Adds performance indexes
5. Logs all changes

## Configuration

### Drizzle Configs (Multi-Provider)
```typescript
// SQLite: drizzle.config.ts
export default {
  schema: "./src/schema/index.ts",
  out: "./src/migrations/generated",
  dialect: "sqlite",
  dbCredentials: { url: process.env.DATABASE_URL || "./ccflare.db" },
} satisfies Config;

// PostgreSQL: drizzle.config.postgresql.ts
export default {
  schema: "./src/schema/index.ts",
  out: "./src/migrations/generated-postgresql",
  dialect: "postgresql",
  dbCredentials: { url: process.env.DATABASE_URL || "postgresql://localhost:5432/ccflare" },
} satisfies Config;

// MySQL: drizzle.config.mysql.ts
export default {
  schema: "./src/schema/index.ts",
  out: "./src/migrations/generated-mysql",
  dialect: "mysql",
  dbCredentials: { url: process.env.DATABASE_URL || "mysql://localhost:3306/ccflare" },
} satisfies Config;
```

### Migration Generation
```bash
# Generate migrations for all providers
bun run generate-migrations

# Or generate for specific providers
bun run migrate:sqlite
bun run migrate:postgresql
bun run migrate:mysql
```

### Environment Variables
```bash
DATABASE_PROVIDER=sqlite|postgresql|mysql
DATABASE_URL=your-database-connection-string
```

## Best Practices

### ‚úÖ Do
- Use `DrizzleDatabaseOperations` for new code
- Define schema changes in `src/schema/` files
- Test migrations with both fresh and legacy databases
- Use proper TypeScript types from schema definitions

### ‚ùå Don't
- Use the legacy `DatabaseOperations` class
- Modify `migrations.ts` (deprecated)
- Create raw SQL migrations
- Bypass the migration compatibility layer

## Troubleshooting

### Legacy Database Issues
If you encounter issues with legacy databases:

1. Check logs for migration compatibility messages
2. Verify all required columns exist
3. Run schema validation: `SchemaValidator.validateSchema()`

### Fresh Installation Issues
For new installations:

1. Ensure proper database provider configuration
2. Check database connection permissions
3. Verify schema files are properly imported

### Multi-Provider Issues
When switching providers:

1. Export data from current provider
2. Configure new provider
3. Import data to new provider
4. Update connection configuration

## Future Roadmap

- [ ] Generate proper Drizzle migration files
- [ ] Add migration rollback support
- [ ] Implement cross-provider data migration tools
- [ ] Add schema versioning
- [ ] Remove legacy migration system (v2.0)

## Support

For migration issues:
1. Check the logs for detailed error messages
2. Verify database permissions and connectivity
3. Ensure all required environment variables are set
4. Test with a fresh database to isolate issues
